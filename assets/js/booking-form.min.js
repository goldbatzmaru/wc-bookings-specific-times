jQuery(document).ready(function($) {

	if ( ! window.console ) {
		window.console = {
			log : function(str) {
				// alert(str);
			}
		};
	}

	var xhr = [];
	var specific_times_data = [];
	var duration_field = $('p.wc_bookings_field_duration');
	var duration_select = $('#wc_bookings_field_duration');
	var blockPickerWrapper = $('#block-picker-wrapper');
	var blockPicker = $('#wc-bookings-booking-form').find('.block-picker');
	var blockPickerChildren = $('#wc-bookings-booking-form').find('.block-picker').children();
	var blockPickerChildCount = blockPickerChildren.length;

	var productId = $('.wc-booking-product-id').val();
	var current_start_time = null;

	$('.wc-bookings-date-picker')
		.on('change', 'input, select', function( e ) {
			$('p.wc_bookings_field_duration').hide();
			if(!$('.single_add_to_cart_button').hasClass('disabled')){
				$('.single_add_to_cart_button').addClass('disabled');
			}
		});

	$('.wc_bookings_field_duration')
		.on('change', 'input, select', function( e ) {
			if(!$('.single_add_to_cart_button').hasClass('disabled')){
				$('.single_add_to_cart_button').addClass('disabled');
			}
		});

	$('#block-picker-wrapper')
		.on('click touch', function( e ) {
			if(!$('.single_add_to_cart_button').hasClass('disabled')){
				$('.single_add_to_cart_button').addClass('disabled');
			}
		});
	$('.wc-bookings-booking-form')
		.on('change', 'input, select', function( e ) {

			var name  = $(this).attr('name');
			
			var $fieldset = $(this).closest('fieldset');
			var $picker   = $fieldset.find( '.picker:eq(0)' );
			if ( $picker.data( 'is_range_picker_enabled' ) ) {
				if ( 'wc_bookings_field_duration' !== name ) {
					return;
				}
			}

			var index = $('.wc-bookings-booking-form').index(this);
			$form = $(this).closest('form');
			var isEmptyCalendarSelection =  ! $form.find( "[name='wc_bookings_field_start_date_day']" ).val() &&
										! $form.find( '#wc_bookings_field_start_date' ).val();

			// If it's the resource dropdown, and no time block was actually selected
			// we refresh the datepicker so that the calendar availability reflects
			// the potential differences, where it may differ for different resources.
			if ( 'wc_bookings_field_resource' === name && isEmptyCalendarSelection ) {
				wc_bookings_date_picker.refresh_datepicker();
				return;
			}

			// Do not update if triggered by Product Addons and no date is selected.
			if ( jQuery(e.target).hasClass('addon') && isEmptyCalendarSelection ) {
				return;
			}

			var required_fields = $form.find('input.required_for_calculation');
			var filled          = true;
			$.each( required_fields, function( index, field ) {
				var value = $(field).val();
				if ( ! value ) {
					filled = false;
				}
			});
			if ( ! filled ) {
				$form.find('.wc-bookings-booking-cost').hide();
				return;
			}

			$form.find('.wc-bookings-booking-cost').block({message: null, overlayCSS: {background: '#fff', backgroundSize: '16px 16px', opacity: 0.6}});
			var add_to_cart_button = $form.find('.single_add_to_cart_button');
			add_to_cart_button.addClass('disabled');

			specific_times_data[index] = $.ajax( {
		        	type: 			'POST',
					url: 		booking_form_params.ajax_url,
					data: 		{
						action: 'wc_bookings_get_specific_times_info',
						product_id: productId
		        }
		    } )
	        .done( function( data ) {
	            // Handles successful responses only
	        } )
	        .fail( function( reason ) {
	            console.info( reason );
	        } )
	        // Promise finished:
	        .then( function( specific_times_data ) {
	          xhr[index] =  $.ajax({
					type: 		'POST',
					url: 		booking_form_params.ajax_url,
					data: 		{
						action: 'wc_bookings_st_calculate_costs',
						form:   $form.serialize()
					},
					success: 	function( code ) {
						if ( code.charAt(0) !== '{' ) {
							console.log( code );
							code = '{' + code.split(/\{(.+)?/)[1];
							code = code.replace("]", "");
						}

						result = $.parseJSON( code );

						if ( result.result == 'ERROR' ) {
							$form.find('.wc-bookings-booking-cost').html( result.html );
							$form.find('.wc-bookings-booking-cost').unblock();
							if(!add_to_cart_button.hasClass('disabled')){
								add_to_cart_button.addClass('disabled');
							}
						} else if ( result.result == 'SUCCESS' ) {
							specific_times_data = jQuery.parseJSON(specific_times_data);
							var origHtml = $.parseHTML(result.html);
							var allowed_times = specific_times_data[0];
							var	allowed_times_cleaned = [];
							$.each(allowed_times, function(index, value){
								allowed_times_cleaned.push(String(value));
							});
							var times_info = specific_times_data[1];
							var selected_block = $('.block-picker li a.selected');
							var selected_block_data = times_info[selected_block.parent().attr('data-block')];
							var duration_select = $('#wc_bookings_field_duration');
							if(current_start_time != selected_block.parent().attr('data-block')) {
								duration_select.children('option').remove();
		
								duration_select.append('<option disabled selected="selected"> -- Select an Hour Amount -- </option>');
								$.each(selected_block_data, function(i, v){
									duration_select.append('<option value="' + i +'">' + i + '</option>');
								});

								current_start_time = selected_block.parent().attr('data-block');
							}
							
							var selected_duration_int = duration_select.val();
							duration_field.show();
							var selectedPrice = selected_block_data[selected_duration_int];
							if(selectedPrice % 1 == 0){
								selectedPrice = selectedPrice + '.00';
							}
							$form.find('.wc-bookings-booking-cost').html( result.html );
							$form.find('.wc-bookings-booking-cost').unblock().show();

							setTimeout(function(){
								if(add_to_cart_button.hasClass('disabled')){
									if($('.no-class').length){
										add_to_cart_button.removeClass('disabled');
									}
								}
								
							}, 2000);
							
						} else {
							$form.find('.wc-bookings-booking-cost').hide();
							if(!add_to_cart_button.hasClass('disabled')){
								add_to_cart_button.addClass('disabled');
							}
							console.log( code );
						}

						$( document.body ).trigger( 'wc_booking_form_changed' );
					},
					error: function() {
						$form.find('.wc-bookings-booking-cost').hide();
						if(!add_to_cart_button.hasClass('disabled')){
							add_to_cart_button.addClass('disabled');
						}
					},
					dataType: 	"html"
				});
	        } );
		})
		.each(function(){
			var button = $(this).closest('form').find('.single_add_to_cart_button');

			button.addClass('disabled');
		});

	$( '.single_add_to_cart_button' ).on( 'click', function( event ) {
		if ( $(this).hasClass('disabled') ) {
			alert( booking_form_params.i18n_choose_options );
			event.preventDefault();
			return false;
		}
	})

	$('.wc-bookings-booking-form, .wc-bookings-booking-form-button').show().removeAttr( 'disabled' );

	//initial hiding of duration field
	if(duration_field.length){
		duration_field.hide();
		duration_select.children('option').remove();
	}

		function remove_disallowed_times(allowedTimes, blockPickerChildren){
		$.each(blockPickerChildren, function(index, value){
			if($.inArray($(value).attr("data-block"), allowedTimes) == -1){
				blockPickerChildren[index].remove();
			}	
		});
	}

	function is_single_time_block(blockPicker, blockPickerChildCount) {
		if(blockPickerChildCount == 1){
			if(blockPicker.children().hasClass('block')) {
  				return true;
  			}
		} else {
			return false;
		}
	}
});
